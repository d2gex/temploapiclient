---
title: "Create species, individuals, tags, sensors and link them all"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Create species, individuals, tags, sensors and link them all}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
# Initial Setup and Api Credentials
This setup is consistent across all vignettes and has been copied over for demonstration purposes. If you run the entire vignette at once, a new R session will start each time, so make sure to install the `temploapiclient` package beforehand. You can do this by using `install.packages`, `renv::install` for virtual environments, or `pkgdown::build_site` if you want to generate local documentation. The last command will also temporarily install the R package being showcased to make it available in the vignettes.

Alternatively, if you'd like to run each section individually, load `temploapiclient` with `devtools::load_all` and set the working directory to `temploapiclient/vignettes` using `setwd()`.
```{r setup}
project_folder <- dirname(getwd())
path_to_env <- file.path(project_folder, ".env")
readRenviron(path_to_env)
api_base_url <- Sys.getenv("API_BASE_URL")
```
```{r instantiate_client}
templo_client <- temploapiclient::TemploApiClient$new(api_base_url)
library("magrittr") # Make '%>%' available throughout the vignette
```
# Initial Setup and Api Credentials
In order to add tagged individuals to the database and given that we are using a relational databases, the four elements making up the relationship should be inserted one by one and in chronological order as follows:

1. Insert first species if it is not yet in the database
2. Insert associated sensors with tags
3. Insert tags
4. Insert individuals
5. Establish the necessary links between them all.

Fortunately for us, the API has been shipped with a method that wraps up the last 4 actions allowing them to be completed at once.

## Create a new species
Species table contains two unique names: `scientific_name` and `common_name`. This means that such names cannot be duplicated in any way across, for example, two records.
```{r species_insertion, eval = FALSE}
ret <- templo_client$add_single_record_and_fetch_id(end_point = "species/", data = list(
  scientific_name = "Trisopterus luscus",
  common_name = "Faneca"
))
ret
```
Then we double check that faneca has been send and stored successfully.
```{r speices_checkup}
api_data <- templo_client$get_dataframe_end_point(end_point = "species/")
api_data %>%
  dplyr::filter(common_name == "Faneca") %>%
  assertr::verify(nrow(.) == 1) # It will halt the execution and print an error if such record does not exist
```
