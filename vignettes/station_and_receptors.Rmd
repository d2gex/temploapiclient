---
title: "station_and_receptors"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{station_and_receptors}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
author: d2g
date: 06-11-2024
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# Setup
 This vignette will create a virtual environment in the parent folder of the working directory and install
 `temploapiclient`. The name of the renv project will be `.temploaplicient_tmp`  - you can name is as you like by
 modifying the code below.
Alternatively you can skip this code and install `temploapiclient` system-wide by using `install.packages`.

```{r setup}
project_parent_path <- dirname(dirname(getwd())) #
renv_project_path <- file.path(project_parent_path, ".temploaplicient_tmp")
r_environ <- file.path(project_parent_path, ".temploapiclient_env")
if (!file.exists(renv_project_path)) {
  renv::init(project = renv_project_path)
  renv::install(c("assertr", "dplyr", "stringi"),
    prompt = FALSE,
    project = renv_project_path
  )
} else {
  renv::activate(project = renv_project_path)
}
if (!require("temploapiclient", quietly = TRUE)) {
  renv::install("d2gex/temploapiclient",
    prompt = FALSE,
    project = renv_project_path
  )
}
library("magrittr")
```
# API credentials reading
It gets the base url where the API is hosted from the hard-drive to avoid pasting here the URL and
instantiate the object templo_client.
```{r}
readRenviron(r_environ)
api_base_url <- Sys.getenv("API_BASE_URL") #
templo_client <- temploapiclient::TemploApiClient$new(api_base_url)
```
# Creating stations, receptors and linking both
Stations and receptors have a 1:N relationship where one station could be associated to multiple receptors. In order to build such relationship the following steps need to be taken in chronological order:

1. Add a station if it is not already created.
2. Add as many receptors, one by one, as required.
3. Link the station with all its potential associated receptors.
4. Repeat 1 to 4 for as many stations as required.

## Creating stations
Create a new receptor and give it the name "Cies 2". If something unexpected happens, an error will be outputted. The
code is commented out because a record can only be inserted once. Tough not shown here, when successful, the api call
return the record just inserted with a new generated `id`.
```{r}
# ret <- templo_client$add_single_record_and_fetch_id(end_point = "stations/", data = list(
#   name = "Cies 2",
#   description = "Western area of cies"
# ))
```
Ensure that such receptor was sent and stored in the database by retrieving it from the API.
```{r}
api_data <- templo_client$get_dataframe_end_point(end_point = "stations/")
api_data %>%
  dplyr::filter(name == "Cies 2") %>%
  assertr::verify(nrow(.) == 1) # It will halt the execution and print an error if such record does not exist
```
## Creating receptors
Receptors, besides a name, requires a unique string that identify them and that is stored in `serial_id`. As for
receptors, a new generated `id` is returned when successful. Otherwise, an error is printed.
```{r}
# serial_id <- stringi::stri_rand_strings(1, 10)
# ret <- templo_client$add_single_record_and_fetch_id(end_point = "receptors/", data = list(
#   name = "Buoy C21",
#   serial_id = serial_id,
#   description = "Receptor set up on a buoy"
# ))
```
Ensure that such station was sent and stored in the database by retrieving it from the API.
```{r}
api_data <- templo_client$get_dataframe_end_point(end_point = "receptors/")
api_data %>%
  dplyr::filter(name == "Buoy C21") %>%
  assertr::verify(nrow(.) == 1)
```
## Associating receptors to stations
Once we have created receptors and stations separately, we may associate them by using a table that relate the two and
represented by the endpoint `stations_receptors`. Notice that you've got to do that by picking the ids returned from
earlier calls.

```{r}
data <- list(
  stations_id = 198, # station that we just created by the name of "Cies 2"
  receptors_id = 9, # receptor stored as "Buoy C21"
  is_active = TRUE, # it indicates the receptor is active
  latitude = 42.2134,
  longitude = -8.8987,
  deployment_date = "2024-11-07 08:25:00" # Notice that dates are in yms_hms format
)
ret <- templo_client$add_single_record_and_fetch_id(end_point = "stations_receptors/", data = data)
```
Again, and for demonstrative purposes, we ensure that the association was successfully implemented by querying the API.
```{r}
api_data <- templo_client$get_dataframe_end_point(end_point = "stations_receptors/")
api_data %>%
  dplyr::filter(stations_id == 198 & receptors_id == 9) %>%
  assertr::verify(nrow(.) == 1)
```
